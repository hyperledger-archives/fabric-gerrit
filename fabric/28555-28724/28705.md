<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 28705<br><strong>Subject</strong>: FAB-13665 consensus migration: kafka2raft green path #2<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/14/2019, 11:47:39 AM<br><strong>LastUpdated</strong>: 2/13/2019, 4:20:23 AM<br><strong>CommitMessage</strong>:<br><pre>FAB-13665 consensus migration: kafka2raft green path #2

This is the second of four (2/4) sub-tasks that focus on
the "green" path of consensus-type migration from Kafka to Raft.

By "green" we mean that there are no failures or aborts along
the way. The 4 sub-tasks are staged in a way that minimizes
dependencies between them.

In this sub-task we introduce a new package:
orderer/consensus/migration. In this package we introduce the
migration Status, which hold the state and context of each chain,
and the migration Stepper, which enforces the migration state machine
in the Kafka chain, post-ordering (i.e. after messages are consumed
from Kafka). It also defines the interface of the migration Controller
which is implemented by the Registrar.

See respective JIRA item for further details.

Change-Id: Ifaad95bcf3bc8fb889ab5f65e817bfe1ebdfa771
Signed-off-by: Yoav Tock <tock@il.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/14/2019, 11:47:39 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:50:47 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8996/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:51:21 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:57:19 AM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:58:09 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8996/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/8996</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:59:12 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7946/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:59:41 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 11:59:47 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4716/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 12:00:28 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 12:27:38 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 12:35:55 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 12:36:40 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7946/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/7946

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4716/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/4716</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/15/2019, 10:36:04 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review-1

(3 comments)

reviewing in progress...</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/17/2019, 5:09:15 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2: Patch Set 1 was rebased.</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/17/2019, 2:49:05 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 2:51:44 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/9148/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 2:53:09 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 2:58:43 PM<br><strong>Message</strong>: <pre>Patch Set 3: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 2:59:33 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/9148/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/9148</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:01:23 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/8074/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:01:38 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4819/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:02:46 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:04:54 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:37:44 PM<br><strong>Message</strong>: <pre>Patch Set 3: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:43:49 PM<br><strong>Message</strong>: <pre>Patch Set 3: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2019, 3:44:32 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/8074/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/8074

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4819/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/4819</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/21/2019, 9:43:37 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4: Patch Set 3 was rebased.</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/23/2019, 7:01:29 AM<br><strong>Message</strong>: <pre>Uploaded patch set 5: Patch Set 4 was rebased.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/24/2019, 2:40:36 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(3 comments)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/24/2019, 4:06:37 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/24/2019, 4:24:30 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/24/2019, 7:14:49 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(6 comments)

Thanks for the review, Jay!</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/24/2019, 8:17:46 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/24/2019, 9:20:51 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/24/2019, 9:21:57 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

> Patch Set 5:
> 
> (1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/27/2019, 3:19:34 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(2 comments)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/27/2019, 8:15:52 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/27/2019, 8:33:27 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/27/2019, 8:46:45 AM<br><strong>Message</strong>: <pre>Uploaded patch set 6: Patch Set 5 was rebased.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/27/2019, 9:22:06 AM<br><strong>Message</strong>: <pre>Patch Set 6:

(1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/28/2019, 2:39:27 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

Thanks for this, Jay, you've hit the mark here.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/28/2019, 3:24:47 AM<br><strong>Message</strong>: <pre>Patch Set 6:

(1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 1/31/2019, 11:50:21 AM<br><strong>Message</strong>: <pre>Uploaded patch set 7: Patch Set 6 was rebased.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 2/1/2019, 3:15:23 AM<br><strong>Message</strong>: <pre>Patch Set 7:

(7 comments)

Generally LGTM other than some nits</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 2/3/2019, 4:31:06 AM<br><strong>Message</strong>: <pre>Patch Set 7:

(7 comments)

I will address all this comments in the CR that implements FAB-13247, the next one, which significantly changes this package anyway.</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 2/3/2019, 7:46:57 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 2/4/2019, 6:02:25 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 2/5/2019, 10:39:53 AM<br><strong>Message</strong>: <pre>Patch Set 7: Code-Review-1

(12 comments)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 2/5/2019, 1:00:05 PM<br><strong>Message</strong>: <pre>Patch Set 7:

@Artem, @Yacov: You have contributed to the high-level design [1] of this work so you're aware of the end goal here. Please review this stack and comment on its mergeability when you get a few cycles.

[1] https://docs.google.com/document/d/1sDSsehNR2vLf1cgZzsAjTCsoSyy0CpUg5rOb4YmXi00/edit</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 2/6/2019, 5:57:25 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(6 comments)

> @Artem, @Yacov: You have contributed to the high-level design [1] of this work so you're aware of the end goal here. Please review this stack and comment on its mergeability when you get a few cycles.

I see there are still several open threads with you and Jay, so will wait to make final pass once all them are resolved. Provided meanwhile a few nits.</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 2/6/2019, 6:18:52 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(2 comments)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 2/11/2019, 1:25:09 PM<br><strong>Message</strong>: <pre>Patch Set 7: -Code-Review</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 2/12/2019, 4:01:33 AM<br><strong>Message</strong>: <pre>Patch Set 7:

(20 comments)

Thanks for the review! Some of the comments I fixed here. Some comments are already fixed upstream. Some comments (renaming and  refactoring the type structure) will be handled in the CR that handles FAB-13247.</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 2/12/2019, 4:08:44 AM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:11:01 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/10013/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:11:29 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Starting verify build</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 2/12/2019, 4:16:28 AM<br><strong>Message</strong>: <pre>Uploaded patch set 9.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:17:26 AM<br><strong>Message</strong>: <pre>Patch Set 8: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/10013/ : ABORTED

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/10013</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:18:26 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/10014/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:18:56 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:25:31 AM<br><strong>Message</strong>: <pre>Patch Set 9: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:26:37 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/10014/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/10014</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:27:57 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/8831/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:28:23 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:29:16 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/5597/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:29:52 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 4:55:54 AM<br><strong>Message</strong>: <pre>Patch Set 9: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 5:07:36 AM<br><strong>Message</strong>: <pre>Patch Set 9: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/12/2019, 5:08:28 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/8831/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/8831

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/5597/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/5597</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 2/12/2019, 9:31:37 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review+2</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 2/13/2019, 3:35:22 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review+2</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 2/13/2019, 3:35:37 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Artem Barger</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/13/2019, 3:37:49 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/5654/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/13/2019, 3:38:27 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/4339/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/13/2019, 4:20:23 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/5654/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/5654

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/4339/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/4339</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/14/2019, 11:47:39 AM<br><strong>UnmergedRevision</strong>: [8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c](https://github.com/hyperledger-gerrit-archive/fabric/commit/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 11:57:19 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 11:57:19 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 12:35:55 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 12:27:38 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Approved</strong>: 1/15/2019, 10:36:04 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L49](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L49)<br><strong>Comment</strong>: <pre>i'm actually wondering why do we need this to be an interface? also, generally speaking, it's more idiomatic for a func to "take interface, return object"</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L49](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L49)<br><strong>Comment</strong>: <pre>This is funny... I did this in response to an earlier comment by Kostas that went in the opposite direction... It was a concrete type in an earlier patch. However, I think Kostas was right. Some objects require just the Status API (registrar, all chains but kafka), and some the Status and Stepper API. Thus, I created the StatusStepper by composition, and each target saves it as the interface it needs to use. It is actually good practice to return an interface and NOT an object from factory methods. This way you can change the underlying object implementation you return without changing the objects that consume the interface. So lets leave it like that.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L49](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L49)<br><strong>Comment</strong>: <pre>we have multiple ongoing threads on this subjects and i guess this quickly turns into another "whether it is right to apply XXX pattern here" debate, which doesn't always lead to consensus :),

i'm merely following the "accept interface, return struct" school of thinking, and i don't think it's a factory, but a constructor. and we should avoid preemptive interfaces.

however, l could live with it, and let's leave it this way</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L49](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L49)<br><strong>Comment</strong>: <pre>I appreciate your comment; I think that software engineering has a lot of "degrees of freedom", and that there is not one "correct" solution to every problem.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L106)<br><strong>Comment</strong>: <pre>you can leave out these fields. using of default values are encouraged. In this light, why is this constructor necessary?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L106)<br><strong>Comment</strong>: <pre>You are correct about defaults. C++ habits die hard. 

But I do need this factory method in order to hide StatusImpl from whoever consumes StatusStepper or Status interfaces. 
For example, it would be messy, unsafe, and a duplication of code to decorate the logger exactly the way I want it in all the places where I use StatusStepper/Status. 
Lets keep it.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L216](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L216)<br><strong>Comment</strong>: <pre>is pending == is of state MIG_STATE_START?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L216](https://github.com/hyperledger-gerrit-archive/fabric/blob/8028f2c01e13bc3eec06e64a9ae9c9d176e80d8c/orderer/consensus/migration/migration.go#L216)<br><strong>Comment</strong>: <pre>Yes</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/17/2019, 5:09:15 AM<br><strong>UnmergedRevision</strong>: [7106374e358ef890e67a4d37ef375faaa80bfa84](https://github.com/hyperledger-gerrit-archive/fabric/commit/7106374e358ef890e67a4d37ef375faaa80bfa84)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 11:57:19 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 11:57:19 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 12:35:55 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 12:27:38 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Approved</strong>: 1/15/2019, 10:36:04 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/17/2019, 2:49:05 PM<br><strong>UnmergedRevision</strong>: [a9a122f4bf0b8abe3084268c78e86f8b73366388](https://github.com/hyperledger-gerrit-archive/fabric/commit/a9a122f4bf0b8abe3084268c78e86f8b73366388)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:43:49 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:37:44 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/21/2019, 9:43:37 AM<br><strong>UnmergedRevision</strong>: [68ec814d6f8c2c41ca41d167629cd3fa9a8f5f6e](https://github.com/hyperledger-gerrit-archive/fabric/commit/68ec814d6f8c2c41ca41d167629cd3fa9a8f5f6e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:43:49 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:37:44 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/23/2019, 7:01:29 AM<br><strong>UnmergedRevision</strong>: [c3627f600e4586597f56f6daee124763394119d4](https://github.com/hyperledger-gerrit-archive/fabric/commit/c3627f600e4586597f56f6daee124763394119d4)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:43:49 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:37:44 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L52)<br><strong>Comment</strong>: <pre>leftover question from previous version of CR stack: why do we need `Status` and `Stepper` interfaces? see https://github.com/golang/go/wiki/CodeReviewComments#interfaces</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L52)<br><strong>Comment</strong>: <pre>Had a brief offline discussion with Yoav, quoting him here:

>  all chains need `Status`, but the kafka chain needs both `Status` and `Stepper`. So I build `StatusStepper` from two interfaces. I could have built `StatusStepper` differently though, from embedded `Status` + one more method - `Step()

However, I would argue, this doesn't prevent us from using plain struct, instead of interfaces. Also, i would say `etcdraft` chain would need `Step()` too, for etcdraft->bft migration.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L52)<br><strong>Comment</strong>: <pre>As to BFT, when we have it, we'll change what etcdraft consumes. There are many places in the code-base that explicitly limit migration from kafka to raft only - on purpose. 

As to the pattern, I repeat - @kostas asked for this to be this way in a previous CR, and I agree with him: hiding the internal struct is GOOD. So lets give it a rest please.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L52)<br><strong>Comment</strong>: <pre>> As to the pattern, I repeat - @kostas asked for this to be this way in a previous CR, and I agree with him: hiding the internal struct is GOOD.

I trust you more than I trust myself, but I'm curious about my earlier comment here. Can you point me to it?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L52)<br><strong>Comment</strong>: <pre>Somewhere here: https://gerrit.hyperledger.org/r/#/c/28435/ I don't have time to look for that. Look for it, if you think it is important.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L52)<br><strong>Comment</strong>: <pre>Sometimes I think we're overlooking that this is an open-source project. This previous interaction comes to mind: https://gerrit.hyperledger.org/r/c/28435/7/orderer/common/bootstrap/file/bootstrap_test.go#213

Solving the problem is important, but doing it in a relatively clean way, with code that can be read and understood by others, and is inline with the rest of the codebase (or the direction we've agreed to take it anyway) is also important.

This line of work touches on a hot path that is tied to a release deadline. The stakes are therefore higher, and the frustration with any amount of focus on how the code/abstraction looks (versus whether it works or not) might be somewhat understandable.

I sympathize with this, especially as the days go by; as I noted in yesterday's scrum, we were OK with fixing several of these issues in later CRs, given the depth of the stack and the lack of familiarity with Go's idioms.

None of that justifies this response:

> I don't have time to look for that. Look for it, if you think it is important.

Your time is not more important than mine or anybody else's. And do note that I took the time to read the previous revision of this CR, and left 100+ comments on it.

Jay also took the time to leave good, thoughtful comments in this revision, some of which you dismiss with lines I've never seen before from an IC in all the time I'm involved in this project ("let's give it a rest please", "when I have time, I'll reconsider").

This line of responses is not OK.

Perhaps the nonchalant way in which I asked the question is giving the wrong impression that I'm just looking to kill time â€” I am not.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>I don't understand something... shouldn't `SetStateContext` be called somewhere in this method? otherwise how do you transition the status to another? also, i'm expecting the UT to cover this, something like

```
status.SetStateContext(foo, bar)
status.Step(blah, blah)
afterState, afterContext = status.StateContext()
// some assertions on afters

```</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>Found the answer in next CR. Next StateContext is set by external callers (Registrar, Chain)

However, this sends out a really mixed message: _not only state machine can transition itself upon an event, but also external callers_ and I think we should be consistent here. Otherwise, `Step` seems to be `IsStepValid` for sys channel (and for app channel, you do set StateContext in certain case)</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>The Step() calls migrationController (registrar), which changes the state after checking that all preconditions are met. This is necessary because this needs to be done under the registrar.lock to avoid races.
So it is consistent - the state change is applied in the scope of this call.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>I'd say if we are to implement a state machine, we should *only* expose `Step` and `GetState` on a state, to make it self contained. otherwise, you are setting state from several difference source, which makes it hard to maintain, and error prune.

Also, isn't it still racy if an app channel receives mig config on sys & standard channel in parallel? i.e. in kafka chain, it call `Step` with next state/context, which may or may not be set by sys channel yet, and if different OSNs make different decisions here, don't we have a fork?</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>typo: if an OSN receives mig config on both sys & standard channel in parallel</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>You cannot see the entire picture looking only at this CR. I will shed some light: there are multiple state machines: one for each chain. However, they are not independent - the system channel state transitions is what bind the whole thing together. The system channel uses the registrar ("migrationController" interface) which has access to all chains) in order to check for preconditions on standard channels (e.g. are they all in CONTEXT before commit) before it changes its own. It also changes the state of standard channels from NONE to START and opens the door for CONTEXT to be accepted on standard chains. Again, all this is apparent in the next CR. There is no chance of a race or a fork because the system channel uses the registrar's lock as point of synchronization. This establishes a "happen before" relationship between the events on the system channel (e.g. START) and events of standard channels (e.g. CONTEXT).</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>Yes, I read the next CR before commenting on this one, in order to get the big picture, otherwise it's really impossible to decipher the intention here. So really appreiciate your explanation here!

Just to follow up, if you send START to sys-channel and CONTEXT to app-channel almost the same time, on OSN1, START is checked first (holding registrar lock first), and then CONTEXT is allowed on app channel. However, on OSN2, CONTEXT is checked first, and rejected. Isn't this a fork?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>Very good question. The checks on the registrar and the state transitions on these chains happen AFTER Kafka ordering. Nevertheless, since the "system" topic and "standard-X" topic are not synchronized, what you  describe could have happened, if it wasn't for this counter-measure that I introduced: I am asking the user to get the block number in which the "START" was committed to the ledger, and put it in the ConsensusType.MigrationContext of the config update that has ConsensusType.MigrationState=CONTEXT on standard channel X. 

The user is forced to do: (1) send START on system channel; (2) fetch last config block from system channel, and if it is a START get the block number; (3) Use the block number as the context for the CONTEXT config update on every standard channel.

This way, CONTEXT never arrives before START (if the user follows steps 1-2-3 above).</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>hmm, so i guess if user uses some automation tool to migrate, they should be aware of this.

> The checks on the registrar and the state transitions on these chains happen AFTER Kafka ordering

how does this prevent the problem from happening?

but what if a crashed node is brought up and start draining kafka, where these two tx exist?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>That is a very good point. I am working on it right now, under FAB-13247 which deals with recovery from crashes. It will also handle the reordering scenario you described.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>Cool. I still want to point out here, transition of state should be internalized, and only triggered by external event(operation). It's anti-pattern to *set* a state via caller, and error prone (i.e. the issue we discussed here)

anyway, let's wait for your update</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L196](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L196)<br><strong>Comment</strong>: <pre>+1 to Jay's comment ^^.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L210](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L210)<br><strong>Comment</strong>: <pre>per comment in a previous CR, this perhaps could reuse same mechanism as https://gerrit.hyperledger.org/r/c/28780/3/common/channelconfig/bundle.go#380, just something to take into consideration</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L210](https://github.com/hyperledger-gerrit-archive/fabric/blob/c3627f600e4586597f56f6daee124763394119d4/orderer/consensus/migration/migration.go#L210)<br><strong>Comment</strong>: <pre>Ack, same answer as before. When I have time, I'll reconsider.</pre></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/27/2019, 8:46:45 AM<br><strong>UnmergedRevision</strong>: [b5c76252ef5a9c5f7bd2e9ef87815e6dc144121c](https://github.com/hyperledger-gerrit-archive/fabric/commit/b5c76252ef5a9c5f7bd2e9ef87815e6dc144121c)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:43:49 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:37:44 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1/31/2019, 11:50:21 AM<br><strong>UnmergedRevision</strong>: [b6aedec9627d0a03ab45866ccc892f332ce558d5](https://github.com/hyperledger-gerrit-archive/fabric/commit/b6aedec9627d0a03ab45866ccc892f332ce558d5)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 2:58:43 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:43:49 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2019, 3:37:44 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L26](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L26)<br><strong>Comment</strong>: <pre>can you please add explanation how it differs?</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L30)<br><strong>Comment</strong>: <pre>same as above.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L53](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L53)<br><strong>Comment</strong>: <pre>I'm not really sure why would you need an additional interface combining two others w/o adding an additional APIs?

You can provide implementation for both of these w/o a need to combine them into single one.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L68](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L68)<br><strong>Comment</strong>: <pre>nit: no need to name it here, especially error (the most common return value) is the *only* return value here. Also, it's consistent with `ConsensusMigrationPending` (not named)</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L68](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L68)<br><strong>Comment</strong>: <pre>I'll fix this in the next CR.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L68](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L68)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L73](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L73)<br><strong>Comment</strong>: <pre>(must)</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L73](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L73)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L75](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L75)<br><strong>Comment</strong>: <pre>ditto</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L75](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L75)<br><strong>Comment</strong>: <pre>I'll fix this in the next CR.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L75](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L75)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L80)<br><strong>Comment</strong>: <pre>must</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L80)<br><strong>Comment</strong>: <pre>I'll fix this in the next CR.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L80)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L82)<br><strong>Comment</strong>: <pre>ditto</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L82)<br><strong>Comment</strong>: <pre>I'll fix this in the next CR.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L82)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L88](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L88)<br><strong>Comment</strong>: <pre>If you're implementing both the `Status` and `Stepper` interfaces, there is no reason why your struct name should only reflect only one of these two.

But most importantly, this can simply be an `FSM` struct, or a name that is not tied to the interface. This guide is useful reading: https://rakyll.org/typesystem/ (the "No header files" section in particular is relevant here).</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L88](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L88)<br><strong>Comment</strong>: <pre>Thanks for the link. This is indeed a bad name. I will refactor the type structure of this package on the CR that relates to FAB-13247.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L106)<br><strong>Comment</strong>: <pre>why don't we decorate this logger with "Consensus-type migration" so you don't need to put that to every log message.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L106)<br><strong>Comment</strong>: <pre>I'll fix this in the next CR.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L106)<br><strong>Comment</strong>: <pre>@Jay: Great idea.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L157)<br><strong>Comment</strong>: <pre>I will note that we have a 10-line comment, and I, as a reader, still have no idea about how the arguments of these methods should be set.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L157)<br><strong>Comment</strong>: <pre>I will update this on the CR that relates to FAB-13247.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L158)<br><strong>Comment</strong>: <pre>Which block? The closest thing we have to a block is a reference to a `lastCutBlockNumber` in the argument list. Is that the one?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L158)<br><strong>Comment</strong>: <pre>The block that carries the config update transaction that drives the migration process. Will update the documentation accordingly.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L170](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L170)<br><strong>Comment</strong>: <pre>delete</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L170](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L170)<br><strong>Comment</strong>: <pre>I'll fix this in the next CR.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L170](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L170)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L170](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L170)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L172](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L172)<br><strong>Comment</strong>: <pre>How is this enforced in the code?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L172](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L172)<br><strong>Comment</strong>: <pre>by never calling migrationController method with the ms.mutex locked... 
This is just a note to future maintainers about the implementation.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L179](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L179)<br><strong>Comment</strong>: <pre>Can you probably combine those parameters into single struct? Usually I find it's quite difficult to distinguish later the different between 4th and 5th parameters from the left, while having them within a struct usually more readable.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L179](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L179)<br><strong>Comment</strong>: <pre>Good idea. I can use protos.ConsesusType to combine the "next*" into a struct. I will do it on the CR that relates to FAB-13247.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L180](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L180)<br><strong>Comment</strong>: <pre>We're mixing named returns and non-named returns in this package. Let's switch to non-named returns since named returns are generally considered to be evil; they make things less clear, and I believe I had even seen a proposal calling for their removal in Go 2...</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L180](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L180)<br><strong>Comment</strong>: <pre>I am in the process of removing all unnecessary named returns. However, there are situations in which named returns provide clarity - when you return several element of the same type, for example. Effective Go encourages the use of named returns in such cases: https://golang.org/doc/effective_go.html#named-results. 

See also: https://flaviocopes.com/go-named-return-parameters/. 

I think the proposal for Go 2 was to remove bare returns, not named returns: https://github.com/golang/go/issues/21291
but I am not an expert on that.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L181](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L181)<br><strong>Comment</strong>: <pre>https://gerrit.hyperledger.org/r/c/28435/7/orderer/common/multichannel/blockwriter_test.go#160</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L181](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L181)<br><strong>Comment</strong>: <pre>Ack</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L183](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L183)<br><strong>Comment</strong>: <pre>I would move this log message into if-else and add information about channel type i.e. system vs application.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L183](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L183)<br><strong>Comment</strong>: <pre>There is no need. the String() method on (ms *StatusImpl) provides this info. In addition, the log messages inside stepSystem and stepStandard provide extra info.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L229](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L229)<br><strong>Comment</strong>: <pre>What about commitMigration? Why do we explicitly set commitBlock, but not commitMigration?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L229](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L229)<br><strong>Comment</strong>: <pre>This statement was removed in a later CR. No need to overwrite the default value.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L238](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L238)<br><strong>Comment</strong>: <pre>Let's remove these blank lines before switch-cases in a later CR. You will not find it a blank line before a `case` statement anywhere across this codebase, and I don't think I've ever seen it in a Go codebase either.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L238](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L238)<br><strong>Comment</strong>: <pre>Ack</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L242](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L242)<br><strong>Comment</strong>: <pre>As above, as a reader, when I see commitBlock set to false (the default value for booleans in Go by the way) I am wondering why we leave `commitMigration` out? Is it because it might be set to true later during this call?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L242](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L242)<br><strong>Comment</strong>: <pre>Removed. Only needs to set these to true, otherwise they keep the default of false.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L292](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L292)<br><strong>Comment</strong>: <pre>this is redundant since you have mentioned "%s" in formatting string. you have it here and in several other places, not really critical, but if you do another pass you might also consider to take care of those.</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration.go#L292](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration.go#L292)<br><strong>Comment</strong>: <pre>Fixed in a later CR.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration_test.go#L15](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration_test.go#L15)<br><strong>Comment</strong>: <pre>are these tests parallelizable? I.e. t.Parallel()</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration_test.go#L15](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration_test.go#L15)<br><strong>Comment</strong>: <pre>Not all. But they all run very fast - reported 0.00s when I run them, so not much to gain anyway.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration_test.go#L446](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration_test.go#L446)<br><strong>Comment</strong>: <pre>a leftover?</pre><strong>Commenter</strong>: Yoav Tock - tock@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/migration/migration_test.go#L446](https://github.com/hyperledger-gerrit-archive/fabric/blob/b6aedec9627d0a03ab45866ccc892f332ce558d5/orderer/consensus/migration/migration_test.go#L446)<br><strong>Comment</strong>: <pre>Fixed</pre></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 2/12/2019, 4:08:44 AM<br><strong>UnmergedRevision</strong>: [fc9b6887c56c3163383b1f52462ce61c472a778a](https://github.com/hyperledger-gerrit-archive/fabric/commit/fc9b6887c56c3163383b1f52462ce61c472a778a)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/12/2019, 4:17:26 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 2/12/2019, 4:16:28 AM<br><strong>GitHubMergedRevision</strong>: [9002e75b740f12bddabd36a5dd2f984f08109ba5](https://github.com/hyperledger-gerrit-archive/fabric/commit/9002e75b740f12bddabd36a5dd2f984f08109ba5)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/12/2019, 4:25:31 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/12/2019, 4:25:31 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/12/2019, 5:07:36 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/12/2019, 4:55:54 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 2/12/2019, 9:31:37 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Approved</strong>: 2/13/2019, 3:35:22 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Artem Barger<br><strong>Merged</strong>: 2/13/2019, 3:35:37 AM<br><br></blockquote>